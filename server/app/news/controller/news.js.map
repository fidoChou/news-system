{
    "version": 3,
    "sources": [
        "../../../src/news/controller/news.js"
    ],
    "names": [
        "moment",
        "require",
        "fetchAction",
        "where",
        "get",
        "model",
        "fetchNews",
        "news",
        "__this",
        "promise",
        "data",
        "forEach",
        "item",
        "index",
        "push",
        "resolve",
        "reject",
        "newsid",
        "id",
        "select",
        "cmt",
        "user",
        "userid",
        "cmtuser",
        "news_id",
        "link",
        "cate",
        "cate_id",
        "author_id",
        "res",
        "comment",
        "all",
        "results",
        "map",
        "extra",
        "success",
        "delcateAction",
        "delete",
        "affectedRows",
        "addCateAction",
        "removeAction",
        "addnewsAction",
        "setCorsHeader",
        "post",
        "now",
        "utc",
        "Date",
        "format",
        "title",
        "content",
        "pass",
        "top",
        "imageurl",
        "preview",
        "think",
        "isEmpty",
        "thenAdd",
        "update",
        "timeflag",
        "Number",
        "add",
        "parseInt",
        "resid",
        "fail",
        "topAction",
        "datime",
        "untopAction",
        "console",
        "log",
        "length",
        "updateclickAction",
        "clicked",
        "categorylistAction",
        "cates",
        "uncate",
        "upromise",
        "cateitem",
        "newsitem",
        "undata",
        "json"
    ],
    "mappings": "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",
    "file": "../../../src/news/controller/news.js",
    "sourcesContent": [
        "'use strict'; \nlet moment = require('moment')\nimport Base from '../../common/base/base.js'\nexport default class extends Base{  \n  async fetchAction(){\n    let where = this.get();\n  \tlet news = await this.model(`news`).fetchNews(where);\n    let __this = this;\n    let promise = [];\n    \n    news.data.forEach(async (item,index)=>{          \n      \n      promise.push(new Promise(async (resolve,reject)=>{            \n        // 查找评论\n        let cmt = await __this.model(`comments`).where({newsid:item.id}).select();\n\n        cmt.forEach(async (item,index)=>{\n          let user = `user`\n          let cmtuser = await __this.model(`user`).where({id:item.userid}).select();\n              cmt[index][user] = cmtuser[0];                 \n        })\n\n        //查找分类    \n        let link = await __this.model(`news_cate`).where({news_id:item.id}).select()\n        link.forEach(async (item,index)=>{\n          let cate = \"cate\";     \n          let data = await __this.model(`category`).where({id:item.cate_id}).select()          \n              link[index][cate] = data[0]; \n        })\n\n        \n        // 查找作者\n        let user =await __this.model(`user`).where({id:item.author_id}).select(); \n        \n\n        let res = {\n          cate:link,\n          user: user[0],\n          comment: cmt\n        }\n        resolve(res)\n      }))\n    });    \n    \n    let results = await Promise.all(promise);\n\n\n    news.data.map((item,index)=>{\n      let extra = 'extra';\n      return item[extra] = results[index]\n    })\n\n\n\n\n  \treturn this.success(news);\n  }\n  // 删除分类\n  async delcateAction(){\n    let where = this.get();\n    let affectedRows = await this.model(`news_cate`).where(where).delete();\n  }\n\n  // 新增分类\n  async addCateAction(){;\n\n  }\n  // 删除新闻\n  async removeAction(){\n    let model = this.model(`news`);\n    let id = this.get(`id`);\n    let affectedRows = await model.where({id:id}).delete()\n    return this.success(affectedRows);\n  }\n  async addnewsAction(){\n    this.setCorsHeader();\n    let model = this.model(`news`);    \n    let where =  this.post();\n    let now =  moment.utc(new Date()).format(\"YYYY-MM-DD\");\n    let {id,title,content,pass,extra,top,imageurl,preview} = where;\n    let cate = this.model(`news_cate`);\n    if(!think.isEmpty(id)){\n      extra.cate.forEach(async (item,index)=>{\n        let affectedRows = await cate.thenAdd({\n          news_id:id,\n          cate_id:\n          item.cate.id}\n          ,{news_id:id,\n            cate_id:item.cate.id})\n      })\n      let affectedRows = await model.where({id:id,}).update({\n        title: title,\n        timeflag: now,\n        content: content,\n        pass : Number(pass),\n        top : Number(top),\n        imageurl: imageurl,\n        preview: preview\n      });\n      return this.success(`更新新闻成功`)\n\n    }else{\n        try{\n           await model.add({\n            title: title,\n            timeflag: now,\n            content: content,\n            pass: parseInt(pass),author_id:extra.user.id,\n            imageurl: imageurl,\n            preview: preview\n\n            });\n            extra.cate.forEach(async (item,index)=>{\n              let affectedRows = await cate.add({news_id:resid,cate_id:item.cate.id})\n            }) \n           return this.success(`添加新闻成功`)\n        }catch(err){\n            return this.fail(err)\n        } \n      }\n  }\n  async topAction(){\n    this.setCorsHeader();\n    let news = this.model(`news`);\n    let datime = moment.utc(this.get(`date`)).format(`YYYY-MM-DD`)\n    let res = await news.where({timeflag:datime,top:1}).select();\n        return this.success(res)\n  }\n  async untopAction(){\n    let news = this.model(`news`),\n        datime = moment.utc(this.get(`date`)).format(`YYYY-MM-DD`),\n        res = await news.where({timeflag:datime,top:[\"!=\",1]}).select(); \n        console.log(`untop`+res.length)\n    return this.success(res)\n  }\n  async updateclickAction() {\n    this.setCorsHeader();\n    let { id , clicked } = this.post()\n    let res = await this.model(`news`).where({id:id}).update({clicked:clicked})\n    return this.success(res)\n  }\n  async categorylistAction(){\n    let news = this.model(`news`),\n        cate = this.model(`category`),\n        cates = [],promise = [],where = {},uncate = [],upromise=[],\n        timeflag = moment(this.get(`date`)).format(`YYYY-MM-DD`);\n\n    if(this.id){\n      where = {\n        cate_id:this.id\n      } \n      uncate = await this.model(`news_cate`).where({cate_id:[\"!=\",this.id]}).select();\n    }\n    cates = await this.model(`news_cate`).where(where).select();  \n\n    \n    cates.forEach((item,index)=>{\n      promise.push(new Promise(async (resolve,reject)=>{\n        let cateitem = await cate.where({id:item.cate_id}).select();\n        let newsitem = await news.where({\n            id:item.news_id,\n            timeflag:timeflag}).select();\n        if(newsitem[0]){\n          let res = {\n            cate : cateitem[0],\n            news: newsitem[0]\n          }\n          resolve(res)  \n        }        \n      }))    \n    })\n\n    uncate.forEach((item,index)=>{\n      upromise.push(new Promise(async (resolve,reject)=>{\n        let cateitem = await cate.where({id:item.cate_id}).select();\n        let newsitem = await news.where({\n          id:item.news_id,\n          timeflag:timeflag\n        }).select();\n\n        if(newsitem[0]){\n          let res = {\n            cate : cateitem[0],\n            news: newsitem[0]\n          }\n          resolve(res)  \n        }\n      }))    \n    })\n\n    let data =await Promise.all(promise);    \n    let undata = await Promise.all(upromise)\n    return this.json({\n      cate: data,\n      uncate: undata\n    })\n  }\n}"
    ]
}